<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AG-UI Chat</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f5f5f5; height: 100vh; display: flex; flex-direction: column; }
header { background: #1a1a2e; color: #fff; padding: 16px 24px; display: flex; align-items: center; gap: 12px; }
header h1 { font-size: 18px; font-weight: 600; }
header span { font-size: 12px; background: #16213e; padding: 4px 10px; border-radius: 12px; color: #7ec8e3; }
#chat { flex: 1; overflow-y: auto; padding: 24px; display: flex; flex-direction: column; gap: 16px; }
.msg { max-width: 75%; padding: 12px 16px; border-radius: 16px; line-height: 1.6; font-size: 14px; white-space: pre-wrap; word-break: break-word; }
.msg.user { align-self: flex-end; background: #1a1a2e; color: #fff; border-bottom-right-radius: 4px; }
.msg.assistant { align-self: flex-start; background: #fff; color: #333; border-bottom-left-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
.msg.assistant.streaming { border-left: 3px solid #7ec8e3; }
.msg .cursor { display: inline-block; width: 2px; height: 16px; background: #7ec8e3; animation: blink 0.7s infinite; vertical-align: text-bottom; margin-left: 2px; }
@keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
#input-area { background: #fff; border-top: 1px solid #e0e0e0; padding: 16px 24px; display: flex; gap: 12px; }
#input { flex: 1; border: 1px solid #ddd; border-radius: 24px; padding: 12px 20px; font-size: 14px; outline: none; transition: border-color 0.2s; }
#input:focus { border-color: #7ec8e3; }
#input:disabled { background: #f9f9f9; }
#send { background: #1a1a2e; color: #fff; border: none; border-radius: 24px; padding: 12px 24px; font-size: 14px; cursor: pointer; transition: background 0.2s; }
#send:hover { background: #16213e; }
#send:disabled { background: #999; cursor: not-allowed; }
.status { text-align: center; font-size: 12px; color: #999; padding: 8px; }
</style>
</head>
<body>
<header>
  <h1>AG-UI Chat</h1>
  <span>Azure AI Foundry · Private Endpoint</span>
</header>
<div id="chat">
  <div class="status">메시지를 입력하세요</div>
</div>
<div id="input-area">
  <input id="input" type="text" placeholder="메시지를 입력하세요..." autocomplete="off">
  <button id="send">전송</button>
</div>
<script>
const chat = document.getElementById('chat');
const input = document.getElementById('input');
const send = document.getElementById('send');
const messages = [];

function addMsg(role, text) {
  const el = document.createElement('div');
  el.className = `msg ${role}`;
  el.textContent = text;
  chat.appendChild(el);
  chat.scrollTop = chat.scrollHeight;
  return el;
}

function setLoading(v) {
  input.disabled = v;
  send.disabled = v;
  send.textContent = v ? '응답 중...' : '전송';
}

async function sendMessage() {
  const text = input.value.trim();
  if (!text) return;
  // remove status message
  const status = chat.querySelector('.status');
  if (status) status.remove();

  input.value = '';
  messages.push({ role: 'user', content: text });
  addMsg('user', text);
  setLoading(true);

  const el = addMsg('assistant', '');
  el.classList.add('streaming');
  el.innerHTML = '<span class="cursor"></span>';

  let content = '';
  try {
    const res = await fetch('/api/agent', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Accept': 'text/event-stream' },
      body: JSON.stringify({ messages })
    });
    const reader = res.body.getReader();
    const decoder = new TextDecoder();
    let buf = '';

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      buf += decoder.decode(value, { stream: true });
      const lines = buf.split('\n');
      buf = lines.pop();
      for (const line of lines) {
        if (!line.startsWith('data: ')) continue;
        const data = JSON.parse(line.slice(6));
        if (data.type === 'TEXT_MESSAGE_CONTENT') {
          content += data.delta;
          el.textContent = content;
          el.innerHTML += '<span class="cursor"></span>';
          chat.scrollTop = chat.scrollHeight;
        } else if (data.type === 'TEXT_MESSAGE_END') {
          el.textContent = content;
          el.classList.remove('streaming');
        }
      }
    }
  } catch (e) {
    el.textContent = '⚠ 오류가 발생했습니다: ' + e.message;
    el.classList.remove('streaming');
  }
  messages.push({ role: 'assistant', content });
  setLoading(false);
  input.focus();
}

send.addEventListener('click', sendMessage);
input.addEventListener('keydown', e => { if (e.key === 'Enter') sendMessage(); });
input.focus();
</script>
</body>
</html>
